<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
</head>
<body>
  <h1>Kuliza Codeboard</h1>


  <!--weekly number of commit stats for all devs-->
    <div id="number_of_commits_weekly" style="min-width: 300px; height: 400px; margin: 0 auto"></div>
  <!--weekly number of lines stats-->
    <div id="number_of_lines_weekly" style="min-width: 310px; height: 400px; margin: 0 auto"></div>

  <!--code standard issue-->
    <div id="number_of_issues_weekly" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
  
  <div class="container">
    {% block content %}
      <div id="content">
          <p>Latest commit details:</p>
          <p>Total commits:<span id="total_commits"></span></p>
          <p>Last commit came from:<span id="last_commit_email"></span></p>
          Per user commit entry:<p id="per_user_commits"></p>
      </div>
    {% endblock content %}
  </div>

  <p>Last week user commits: {{weekly_report}}</p>



<script src="//code.jquery.com/jquery-3.1.1.min.js"></script>
  {% block script %}

    <script>
        var socket = new WebSocket('ws://' + window.location.host + '/commit_report/');

        socket.onopen = function open() {
          console.log('WebSockets connection created.');
        };

        socket.onmessage = function message(event) {
          var data = JSON.parse(event.data);
          // NOTE: We escape JavaScript to prevent XSS attacks.
          var count = encodeURI(data['count']);
          var last_entry_email = encodeURI(data['last_entry_email']);
          var user_commits_count = JSON.stringify((data['user_commits_count']));
          $("#total_commits").html(count);
          $("#last_commit_email").html(last_entry_email);
          $("#per_user_commits").html(user_commits_count);
        };

        if (socket.readyState == WebSocket.OPEN) {
          socket.onopen();
        }


        var commit_data = [];
        var names = [];
        var added = [];
        var removed = [];
        var python = [];
        var html = [];
        var javascript = [];


        <!--Iterate over weekly data to provide data points for graph -->
        {% for k, v in weekly_report.items %}
            commit_data.push(['{{v.name}}', {{v.commit_count}}]);
            names.push('{{v.name}}');
            added.push({{v.lines.lines_added}});
            removed.push({{v.lines.lines_removed}});
            python.push({% if v.issues.python %}{{v.issues.python}}{% else %}0{% endif %});
            html.push({% if v.issues.html %}{{v.issues.python}}{% else %}0{% endif %});
            javascript.push({% if v.issues.javascript %}{{v.issues.javascript}}{% else %}0{% endif %});
        {% endfor %}


        Highcharts.chart('number_of_commits_weekly', {
            chart: {
                type: 'column'
            },
            title: {
                text: 'Number of commits per user(weekly)'
            },
            xAxis: {
                type: 'category',
                labels: {
                    rotation: -45,
                    style: {
                        fontSize: '13px',
                        fontFamily: 'Verdana, sans-serif'
                    }
                }
            },
            yAxis: {
                min: 0,
                title: {
                    text: 'Number of commits'
                }
            },
            legend: {
                enabled: false
            },
            tooltip: {
                pointFormat: 'Number of commits: <b>{point.y:.0f} </b>'
            },
            series: [{
                name: 'Number_of_commits',
                data: commit_data,
                dataLabels: {
                    enabled: true,
                    rotation: -90,
                    color: '#FFFFFF',
                    align: 'right',
                    format: '{point.y:.0f}', // one decimal
                    y: 10, // 10 pixels down from the top
                    style: {
                        fontSize: '13px',
                        fontFamily: 'Verdana, sans-serif'
                    }
                }
            }]
        });


        Highcharts.chart('number_of_lines_weekly', {
            chart: {
                type: 'column'
            },
            title: {
                text: 'Number of lines add/remove per user(weekly)'
            },
            xAxis: {
                categories: names,
                crosshair: true
            },
            yAxis: {
                min: 0,
                title: {
                    text: 'Number of lines'
                }
            },
            tooltip: {
                headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                    '<td style="padding:0"><b>{point.y:.0f}</b></td></tr>',
                footerFormat: '</table>',
                shared: true,
                useHTML: true
            },
            plotOptions: {
                column: {
                    pointPadding: 0.2,
                    borderWidth: 0
                }
            },
            series: [{
                name: 'Added',
                data: added

            }, {
                name: 'Removed',
                data: removed
            }]
        });


        Highcharts.chart('number_of_issues_weekly', {
            chart: {
                type: 'column'
            },
            title: {
                text: 'Number of issues per user(weekly)'
            },
            xAxis: {
                categories: names,
                crosshair: true
            },
            yAxis: {
                min: 0,
                title: {
                    text: 'Issues count'
                }
            },
            tooltip: {
                headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                    '<td style="padding:0"><b>{point.y:.0f} </b></td></tr>',
                footerFormat: '</table>',
                shared: true,
                useHTML: true
            },
            plotOptions: {
                column: {
                    pointPadding: 0.2,
                    borderWidth: 0
                }
            },
            series: [{
                name: 'Python',
                data: python

            }, {
                name: 'Html',
                data: html

            }, {
                name: 'JavaScript',
                data: javascript
            }]
        });
    </script>

  {% endblock script %}
</body>
</html>